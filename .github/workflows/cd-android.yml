name: CD - Android Build
run-name: CD - Android Build ‚Äì ${{ github.ref_name }}

on:
  push:
    branches:
      - main
      - feature/*
      - fix/*
  workflow_dispatch:

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'
      
      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'platform-tools platforms;android-34 build-tools;34.0.0 ndk;26.1.10909125'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate native Android project
        run: |
          echo "Generating native Android project with Expo..."
          npx expo prebuild --platform android --clean
        env:
          EXPO_PUBLIC_ENV: production

      - name: Force Gradle 8.5 for Expo Autolinking compatibility
        run: |
          echo "Updating Gradle wrapper to 8.5..."
          if [ -f android/gradle/wrapper/gradle-wrapper.properties ]; then
            sed -i 's#distributionUrl=.*#distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip#g' android/gradle/wrapper/gradle-wrapper.properties
            cat android/gradle/wrapper/gradle-wrapper.properties
          else
            echo "gradle-wrapper.properties not found" && exit 1
          fi
      
      - name: Make Gradlew executable
        run: |
          cd android
          chmod +x gradlew
      
      - name: Build Android APK
        run: |
          echo "Building Android APK..."
          cd android
          ./gradlew assembleRelease --no-daemon --stacktrace
        env:
          EXPO_PUBLIC_ENV: production
      
      - name: Verify APK exists
        run: |
          if [ -f android/app/build/outputs/apk/release/app-release.apk ]; then
            echo "‚úÖ APK built successfully"
            ls -lh android/app/build/outputs/apk/release/app-release.apk
          else
            echo "‚ùå APK not found!"
            find android -name "*.apk"
            exit 1
          fi
      
      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Build version: $VERSION"
      
      - name: Rename APK with version
        run: |
          mkdir -p artifacts
          cp android/app/build/outputs/apk/release/app-release.apk artifacts/pomodoro-timer-v${{ steps.version.outputs.version }}.apk
          echo "Renamed APK to: pomodoro-timer-v${{ steps.version.outputs.version }}.apk"
      
      - name: Generate QR code for APK download
        run: |
          DOWNLOAD_URL="https://github.com/sergiikryshtop/pomodoro-timetracker-app/releases/download/v${{ steps.version.outputs.version }}/pomodoro-timer-v${{ steps.version.outputs.version }}.apk"
          echo "Generating QR code for: $DOWNLOAD_URL"
          curl -o artifacts/qr-code.png "https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=$DOWNLOAD_URL"
          echo "QR code saved to artifacts/qr-code.png"
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: pomodoro-timer-v${{ steps.version.outputs.version }}-android
          path: artifacts/pomodoro-timer-v${{ steps.version.outputs.version }}.apk
          retention-days: 30
      
      - name: Create Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/pomodoro-timer-v${{ steps.version.outputs.version }}.apk
            artifacts/qr-code.png
          body: |
            ## üì± Pomodoro Timer v${{ steps.version.outputs.version }}
            
            ### üì• Quick Install (QR Code)
            
            **Scan this QR code with your Android device to download and install:**
            
            ![Download APK](https://github.com/sergiikryshtop/pomodoro-timetracker-app/releases/download/v${{ steps.version.outputs.version }}/qr-code.png)
            
            Or download manually below ‚¨áÔ∏è
            
            ### üì• Installation
            
            Download the APK below and install on your Android device.
            
            See [INSTALLATION.md](https://github.com/sergiikryshtop/pomodoro-timetracker-app/blob/main/INSTALLATION.md) for detailed installation instructions.
            
            ### ‚ú® Features
            
            - **Timer Management**: Work (25min), Short Break (5min), Long Break (15min)
            - **Session Tracking**: Automatic session persistence with pause duration calculation
            - **Feedback System**: Audio, haptic, and notification alerts on completion
            - **Reports & Analytics**: Date-range aggregation with Victory Native charts
            - **Task Management**: Autocomplete suggestions stored via AsyncStorage
            - **Customizable Settings**: Durations, sounds, vibration preferences via SecureStore
            
            ### üèóÔ∏è Technical Details
            
            - **Framework**: Expo SDK with React Native
            - **State Management**: TimerContext (React hooks)
            - **Storage**: Dual strategy (AsyncStorage for sessions/tasks, SecureStore for settings)
            - **Platform**: Android (Minimum API 21 - Android 5.0)
            - **Build Type**: Release APK (unsigned)
            - **Architecture**: Universal (ARM64, ARMv7, x86)
            
            ### üîß Build Information
            
            - **Workflow Run**: #${{ github.run_number }}
            - **Commit**: ${{ github.sha }}
            - **Build Time**: ${{ github.event.head_commit.timestamp }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build summary
        run: |
          echo "## üéâ Android Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Android" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: Release APK (Native Build)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: ~10-15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "The APK is available in:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Workflow artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ GitHub Release (attached as asset)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Download" >> $GITHUB_STEP_SUMMARY
          echo "Users can download directly from the [Releases page](https://github.com/sergiikryshtop/pomodoro-timetracker-app/releases)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: build-android
    if: always()
    
    steps:
      - name: Build status
        run: |
          if [ "${{ needs.build-android.result }}" == "success" ]; then
            echo "‚úÖ Android build completed successfully!"
          else
            echo "‚ùå Android build failed!"
            exit 1
          fi
